<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·˜ç¥¨ç¥¨ - æ¼”å‡ºç¥¨åŠ¡å¹³å°</title>
    <link rel="stylesheet" href="/assets/css/client-common.css">
    <link rel="stylesheet" href="/assets/css/client.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="container header-inner">
            <a href="index.html" class="logo">
                <span style="font-size: 28px;">ğŸ«</span>
                <span>æ·˜ç¥¨ç¥¨</span>
            </a>

            <nav class="nav">
                <a href="index.html" class="nav-link active">é¦–é¡µ</a>
                <a href="favorites.html" class="nav-link">æˆ‘çš„æ”¶è—</a>
                <a href="order-center.html" class="nav-link">æˆ‘çš„è®¢å•</a>
                <a href="notifications.html" class="nav-link">æ¶ˆæ¯é€šçŸ¥</a>
                <a href="profile.html" class="nav-link">ä¸ªäººä¸­å¿ƒ</a>
            </nav>

            <div class="header-actions">
                <a href="ai-qa.html" class="btn btn-outline btn-small">AIåŠ©æ‰‹</a>
                <div class="user-info" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <div class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center;"></div>
                    <span class="user-name">æœªç™»å½•</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
        <div class="container">
            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-section">
                    <div class="filter-label">åˆ†ç±»</div>
                    <div class="filter-options">
                        <span class="filter-option active" data-category="all">å…¨éƒ¨</span>
                        <span class="filter-option" data-category="concert">æ¼”å”±ä¼š</span>
                        <span class="filter-option" data-category="theatre">è¯å‰§æ­Œå‰§</span>
                        <span class="filter-option" data-category="exhibition">å±•è§ˆä¼‘é—²</span>
                        <span class="filter-option" data-category="sports">ä½“è‚²</span>
                        <span class="filter-option" data-category="music">éŸ³ä¹ä¼š</span>
                        <span class="filter-option" data-category="kids">å„¿ç«¥äº²å­</span>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-label">æ—¶é—´</div>
                    <div class="filter-options">
                        <span class="filter-option active" data-time="all">å…¨éƒ¨</span>
                        <span class="filter-option" data-time="today">ä»Šå¤©</span>
                        <span class="filter-option" data-time="tomorrow">æ˜å¤©</span>
                        <span class="filter-option" data-time="weekend">æœ¬å‘¨æœ«</span>
                        <span class="filter-option" data-time="month">æœ¬æœˆ</span>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-label">æ’åº</div>
                    <div class="filter-options">
                        <span class="filter-option active" data-sort="hot">çƒ­åº¦ä¼˜å…ˆ</span>
                        <span class="filter-option" data-sort="new">æœ€æ–°ä¸Šæ¶</span>
                        <span class="filter-option" data-sort="soonest">å³å°†å¼€å§‹</span>
                    </div>
                </div>
            </div>

            <!-- æ¼”å‡ºåˆ—è¡¨ - é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div class="event-grid" id="eventGrid">
                <!-- åŠ è½½æç¤º -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">åŠ è½½ä¸­...</div>
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">ğŸ­</div>
                    <div class="empty-state-text">æš‚æ— æ¼”å‡ºæ•°æ®</div>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-section-title">å…³äºæˆ‘ä»¬</div>
                    <ul class="footer-links">
                        <li class="footer-link"><a href="#">å…¬å¸ç®€ä»‹</a></li>
                        <li class="footer-link"><a href="#">è”ç³»æ–¹å¼</a></li>
                        <li class="footer-link"><a href="#">åŠ å…¥æˆ‘ä»¬</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <div class="footer-section-title">å¸®åŠ©ä¸­å¿ƒ</div>
                    <ul class="footer-links">
                        <li class="footer-link"><a href="help-center.html">è´­ç¥¨é¡»çŸ¥</a></li>
                        <li class="footer-link"><a href="help-center.html">å¸¸è§é—®é¢˜</a></li>
                        <li class="footer-link"><a href="help-center.html">é€€æ¢ç¥¨æ”¿ç­–</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <div class="footer-section-title">åˆä½œä¼™ä¼´</div>
                    <ul class="footer-links">
                        <li class="footer-link"><a href="#">åœºé¦†åˆä½œ</a></li>
                        <li class="footer-link"><a href="#">ç¥¨åŠ¡ä»£ç†</a></li>
                        <li class="footer-link"><a href="#">å¹¿å‘Šåˆä½œ</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <div class="footer-section-title">å…³æ³¨æˆ‘ä»¬</div>
                    <ul class="footer-links">
                        <li class="footer-link"><a href="#">å®˜æ–¹å¾®ä¿¡</a></li>
                        <li class="footer-link"><a href="#">æ–°æµªå¾®åš</a></li>
                        <li class="footer-link"><a href="#">æŠ–éŸ³å·</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>Copyright Â© 2025 æ·˜ç¥¨ç¥¨ All Rights Reserved. | æ²ªICPå¤‡12345678å·</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/assets/js/client-api.js"></script>
    <script src="/assets/js/client-constants.js"></script>
    <script src="/assets/js/client-events.js"></script>
    <script src="/assets/js/client-sessions.js"></script>
    <script src="/assets/js/client-venues.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        const pageSize = 20;
        let totalPages = 0;
        let currentFilter = {
            category: 'all',
            time: 'all',
            sort: 'hot'
        };

        // é¡µé¢åŠ è½½æ—¶è·å–æ¼”å‡ºåˆ—è¡¨
        window.addEventListener('DOMContentLoaded', loadEvents);

        /**
         * åŠ è½½æ¼”å‡ºåˆ—è¡¨
         */
        async function loadEvents() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const eventGrid = document.getElementById('eventGrid');

            try {
                loadingState.style.display = 'flex';
                emptyState.style.display = 'none';

                const params = {
                    page: currentPage,
                    pageSize: pageSize
                };

                // æ ¹æ®ç­›é€‰æ¡ä»¶æ·»åŠ å‚æ•°
                if (currentFilter.category !== 'all') {
                    params.type = currentFilter.category;
                }

                const result = await getEventList(params);
                const eventList = result.list || [];

                totalPages = Math.ceil((result.total || 0) / pageSize);

                loadingState.style.display = 'none';

                if (eventList.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                renderEventGrid(eventList);

            } catch (error) {
                console.error('åŠ è½½æ¼”å‡ºåˆ—è¡¨å¤±è´¥:', error);
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                const emptyText = emptyState.querySelector('.empty-state-text');

                // å‹å¥½çš„é”™è¯¯æç¤º
                if (error.message.includes('åç«¯æœåŠ¡æœªå“åº”')) {
                    emptyText.innerHTML = `
                        <div style="color: #d32f2f;">åç«¯æœåŠ¡æœªå¯åŠ¨</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #666;">è¯·å¯åŠ¨åç«¯æœåŠ¡ (http://localhost:8080)</div>
                    `;
                } else {
                    emptyText.textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
                }
            }
        }

        /**
         * æ¸²æŸ“æ¼”å‡ºç½‘æ ¼
         */
        function renderEventGrid(events) {
            const eventGrid = document.getElementById('eventGrid');

            eventGrid.innerHTML = events.map(event => {
                const priceRange = getPriceRange(event.ticketTiers);
                const typeText = EVENT_TYPE_MAP[event.type] || event.type;
                const statusInfo = EVENT_STATUS_MAP[event.status];

                return `
                    <div class="event-card" onclick="location.href='event-detail.html?id=${event.id}'">
                        <div class="event-cover" style="background: ${getCoverGradient(event.type)}; height: 200px;">
                            ${event.status === 'sold_out' ? '<div class="event-badge badge-danger">å”®ç½„</div>' : ''}
                        </div>
                        <div class="event-info">
                            <div class="event-title">${event.name}</div>
                            <div class="event-meta">
                                <span>${event.city || 'ä¸Šæµ·'}</span>
                                <span>|</span>
                                <span>${typeText}</span>
                            </div>
                            <div class="event-time">${formatDate(event.eventStartDate)}</div>
                            <div class="event-price">${priceRange}èµ·</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * æ ¹æ®æ¼”å‡ºç±»å‹è·å–å°é¢æ¸å˜è‰²
         */
        function getCoverGradient(type) {
            const gradients = {
                'concert': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'drama': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'musical': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'exhibition': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'sports': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'dance': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            };
            return gradients[type] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }

        /**
         * ç­›é€‰é€‰é¡¹ç‚¹å‡»äº‹ä»¶
         */
        document.querySelectorAll('.filter-option').forEach(option => {
            option.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');

                const filterType = parent.querySelector('.filter-label').textContent;
                if (filterType === 'åˆ†ç±»') {
                    currentFilter.category = this.dataset.category;
                } else if (filterType === 'æ—¶é—´') {
                    currentFilter.time = this.dataset.time;
                } else if (filterType === 'æ’åº') {
                    currentFilter.sort = this.dataset.sort;
                }

                currentPage = 1;
                loadEvents();
            });
        });

        // æ»šåŠ¨åŠ è½½æ›´å¤š
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadMoreEvents();
                }
            }
        });

        /**
         * åŠ è½½æ›´å¤šæ¼”å‡º
         */
        async function loadMoreEvents() {
            try {
                const params = {
                    page: currentPage,
                    pageSize: pageSize
                };

                if (currentFilter.category !== 'all') {
                    params.type = currentFilter.category;
                }

                const result = await getEventList(params);
                const eventList = result.list || [];

                if (eventList.length > 0) {
                    appendEventGrid(eventList);
                }
            } catch (error) {
                console.error('åŠ è½½æ›´å¤šå¤±è´¥:', error);
            }
        }

        /**
         * è¿½åŠ æ¼”å‡ºåˆ°ç½‘æ ¼
         */
        function appendEventGrid(events) {
            const eventGrid = document.getElementById('eventGrid');

            events.forEach(event => {
                const priceRange = getPriceRange(event.ticketTiers);
                const typeText = EVENT_TYPE_MAP[event.type] || event.type;

                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                eventCard.onclick = () => location.href = `event-detail.html?id=${event.id}`;
                eventCard.innerHTML = `
                    <div class="event-cover" style="background: ${getCoverGradient(event.type)}; height: 200px;">
                        ${event.status === 'sold_out' ? '<div class="event-badge badge-danger">å”®ç½„</div>' : ''}
                    </div>
                    <div class="event-info">
                        <div class="event-title">${event.name}</div>
                        <div class="event-meta">
                            <span>${event.city || 'ä¸Šæµ·'}</span>
                            <span>|</span>
                            <span>${typeText}</span>
                        </div>
                        <div class="event-time">${formatDate(event.eventStartDate)}</div>
                        <div class="event-price">${priceRange}èµ·</div>
                    </div>
                `;
                eventGrid.appendChild(eventCard);
            });
        }
    </script>
</body>
</html>
