<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€‰æ‹©åœºæ¬¡ - å‘¨æ°ä¼¦2025å˜‰å¹´åä¸–ç•Œå·¡å›æ¼”å”±ä¼š-ä¸Šæµ·ç«™ - æ·˜ç¥¨ç¥¨</title>
    <link rel="stylesheet" href="/assets/css/client-common.css">
    <link rel="stylesheet" href="/assets/css/client.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="container header-inner">
            <a href="index.html" class="logo">
                <span style="font-size: 28px;">ğŸ«</span>
                <span>æ·˜ç¥¨ç¥¨</span>
            </a>

            <nav class="nav">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="favorites.html" class="nav-link">æˆ‘çš„æ”¶è—</a>
                <a href="order-center.html" class="nav-link">æˆ‘çš„è®¢å•</a>
                <a href="notifications.html" class="nav-link">æ¶ˆæ¯é€šçŸ¥</a>
                <a href="profile.html" class="nav-link">ä¸ªäººä¸­å¿ƒ</a>
            </nav>

            <div class="header-actions">
                <a href="ai-qa.html" class="btn btn-outline btn-small">AIåŠ©æ‰‹</a>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center;">å¼ </div>
                    <span>å¼ ä¸‰</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
        <div class="container">
            <!-- é¢åŒ…å±‘ -->
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">é¦–é¡µ</a></li>
                <li class="breadcrumb-item"><a href="event-detail.html">æ¼”å‡ºè¯¦æƒ…</a></li>
                <li class="breadcrumb-item">é€‰æ‹©åœºæ¬¡</li>
            </ul>

            <h1 class="page-title">é€‰æ‹©åœºæ¬¡</h1>

            <p class="page-subtitle">å‘¨æ°ä¼¦2025å˜‰å¹´åä¸–ç•Œå·¡å›æ¼”å”±ä¼š-ä¸Šæµ·ç«™</p>

            <!-- åœºæ¬¡åˆ—è¡¨ -->
            <div class="session-list" id="sessionList">
                <!-- åŠ è½½æç¤º -->
                <div class="loading-state" id="loadingState" style="padding: 40px 0;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">åŠ è½½ä¸­...</div>
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">ğŸ«</div>
                    <div class="empty-state-text">æš‚æ— åœºæ¬¡ä¿¡æ¯</div>
                </div>
            </div>

            <!-- è´­ç¥¨æç¤º -->
            <div class="detail-section" style="margin-top: 32px;">
                <h2 class="detail-section-title">è´­ç¥¨æç¤º</h2>
                <div class="detail-section-content">
                    <p style="margin-bottom: 12px;"><strong>é€‰åº§è´­ç¥¨ï¼š</strong>å¯ä»¥è‡ªä¸»é€‰æ‹©å…·ä½“åº§ä½ï¼Œé€‚åˆå¯¹ä½ç½®æœ‰æ˜ç¡®è¦æ±‚çš„è§‚ä¼—</p>
                    <p style="margin-bottom: 12px;"><strong>ç¥¨æ¡£è´­ç¥¨ï¼š</strong>é€‰æ‹©ç¥¨æ¡£åç³»ç»Ÿè‡ªåŠ¨åˆ†é…åº§ä½ï¼Œæ›´åŠ å¿«æ·æ–¹ä¾¿</p>
                    <p style="margin-bottom: 12px;"><strong>è´­ä¹°é™åˆ¶ï¼š</strong>æ¯ä¸ªè´¦å·æ¯åœºæ¼”å‡ºæœ€å¤šè´­ä¹°4å¼ é—¨ç¥¨</p>
                    <p style="margin-bottom: 12px;"><strong>å®ååˆ¶ï¼š</strong>æœ¬åœºæ¼”å‡ºå®è¡Œå®ååˆ¶è´­ç¥¨è§‚æ¼”ï¼Œéœ€å¡«å†™è§‚æ¼”äººçœŸå®èº«ä»½ä¿¡æ¯</p>
                    <p><strong>å…¥åœºæ–¹å¼ï¼š</strong>å‡­å€Ÿç”µå­ç¥¨äºŒç»´ç æ‰«ç å…¥åœº</p>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="/assets/js/client-api.js"></script>
    <script src="/assets/js/client-constants.js"></script>
    <script src="/assets/js/client-events.js"></script>
    <script src="/assets/js/client-sessions.js"></script>
    <script src="/assets/js/client-venues.js"></script>
    <script>
        // è·å–URLå‚æ•°ä¸­çš„æ¼”å‡ºID
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');
        let eventName = '';

        // é¡µé¢åŠ è½½æ—¶è·å–åœºæ¬¡åˆ—è¡¨
        window.addEventListener('DOMContentLoaded', async () => {
            if (eventId) {
                // å…ˆè·å–æ¼”å‡ºä¿¡æ¯
                try {
                    const event = await getEventDetail(eventId);
                    eventName = event.name;
                    document.querySelector('.page-subtitle').textContent = eventName;
                    document.title = `é€‰æ‹©åœºæ¬¡ - ${eventName} - æ·˜ç¥¨ç¥¨`;
                    loadEventSessions(eventId);
                } catch (error) {
                    console.error('åŠ è½½æ¼”å‡ºä¿¡æ¯å¤±è´¥:', error);
                }
            } else {
                showErrorMessage('ç¼ºå°‘æ¼”å‡ºIDå‚æ•°');
            }
        });

        /**
         * åŠ è½½åœºæ¬¡åˆ—è¡¨
         */
        async function loadEventSessions(id) {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const sessionList = document.getElementById('sessionList');

            try {
                loadingState.style.display = 'block';
                emptyState.style.display = 'none';

                const result = await getEventSessions(id, { page: 1, pageSize: 100 });
                const sessionListData = result.list || [];

                loadingState.style.display = 'none';

                if (sessionListData.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                renderSessionList(sessionListData);

            } catch (error) {
                console.error('åŠ è½½åœºæ¬¡åˆ—è¡¨å¤±è´¥:', error);
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.querySelector('.empty-state-text').textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        /**
         * æ¸²æŸ“åœºæ¬¡åˆ—è¡¨
         */
        function renderSessionList(sessions) {
            const sessionList = document.getElementById('sessionList');

            // æ¸…ç©ºç°æœ‰å†…å®¹
            sessionList.innerHTML = '';

            sessions.forEach(session => {
                const statusInfo = SESSION_STATUS_MAP[session.status] || { text: session.status, class: 'badge-secondary' };
                const cardStyle = session.status === 'sold_out' ? 'background-color: #f5f5f5; opacity: 0.7;' : '';

                const sessionCard = document.createElement('div');
                sessionCard.className = 'session-card';
                sessionCard.style.cssText = cardStyle;

                // æ ¼å¼åŒ–å¼€å§‹æ—¶é—´
                const startTime = formatSessionTime(session.startTime);

                // ä½™ç¥¨çŠ¶æ€
                let availableStatus = 'ä½™ç¥¨å……è¶³';
                let availableClass = 'badge-info';
                if (session.availableSeats === 0) {
                    availableStatus = 'å·²å”®ç½„';
                    availableClass = 'badge-danger';
                } else if (session.availableSeats < session.totalSeats * 0.2) {
                    availableStatus = 'ä½™ç¥¨ç´§å¼ ';
                    availableClass = 'badge-warning';
                }

                sessionCard.innerHTML = `
                    <div class="session-info">
                        <div class="session-date">${startTime}</div>
                        <div class="session-venue">ğŸ“ ${session.venueName || 'å¾…å®š'}</div>
                        <div style="margin-top: 8px;">
                            <span class="badge ${statusInfo.class}">${statusInfo.text}</span>
                            <span class="badge ${availableClass}" style="margin-left: 8px;">${availableStatus}</span>
                            ${session.availableSeats > 0 ? `<span class="text-muted text-small" style="margin-left: 8px;">å‰©ä½™ ${formatSeatCount(session.availableSeats)} å¼ </span>` : ''}
                        </div>
                    </div>
                    <div class="session-actions">
                        ${renderSessionActions(session)}
                    </div>
                `;

                sessionList.appendChild(sessionCard });
            });

            // æ·»åŠ åŠ è½½æ›´å¤šæŒ‰é’®ï¼ˆå¦‚æœæœ‰æ›´å¤šæ•°æ®ï¼‰
            if (sessions.length > 0) {
                const loadMoreDiv = document.createElement('div');
                loadMoreDiv.style.textAlign = 'center';
                loadMoreDiv.style.padding = '20px 0';
                loadMoreDiv.innerHTML = `<span class="text-muted text-small">å·²æ˜¾ç¤ºå…¨éƒ¨åœºæ¬¡</span>`;
                sessionList.appendChild(loadMoreDiv);
            }
        }

        /**
         * æ¸²æŸ“åœºæ¬¡æ“ä½œæŒ‰é’®
         */
        function renderSessionActions(session) {
            if (session.status === 'sold_out' || session.availableSeats === 0) {
                return `
                    <button class="btn btn-outline" onclick="setReminder(${session.id})">è®¾ç½®ä½™ç¥¨æé†’</button>
                `;
            }

            if (session.status === 'selling_soon') {
                return `
                    <button class="btn btn-primary" onclick="setSaleReminder(${session.id})">è®¾ç½®å¼€å”®æé†’</button>
                `;
            }

            // æ£€æŸ¥é€‰åº§æ–¹å¼
            const seatMode = session.metadata?.seatSelectionMode || 'select';

            if (seatMode === 'select') {
                return `
                    <button class="btn btn-outline" onclick="setReminder(${session.id})">è®¾ç½®æé†’</button>
                    <a href="seat-selection.html?sessionId=${session.id}" class="btn btn-primary">é€‰åº§è´­ç¥¨</a>
                `;
            } else {
                return `
                    <button class="btn btn-outline" onclick="setReminder(${session.id})">è®¾ç½®æé†’</button>
                    <a href="ticket-tier-selection.html?sessionId=${session.id}" class="btn btn-primary">ç¥¨æ¡£è´­ç¥¨</a>
                `;
            }
        }

        /**
         * æ ¼å¼åŒ–åœºæ¬¡æ—¶é—´
         */
        function formatSessionTime(dateTime) {
            if (!dateTime) return 'æ—¶é—´å¾…å®š';
            const date = new Date(dateTime);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekDay = weekDays[date.getDay()];
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥ ${weekDay} ${hours}:${minutes}`;
        }

        /**
         * è®¾ç½®æé†’
         */
        function setReminder(sessionId) {
            alert('æé†’åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        /**
         * è®¾ç½®å¼€å”®æé†’
         */
        function setSaleReminder(sessionId) {
            alert('å¼€å”®æé†’åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
         */
        function showErrorMessage(message) {
            const mainContent = document.querySelector('.main-content .container');
            mainContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âš ï¸</div>
                    <div class="empty-state-text">${message}</div>
                    <a href="index.html" class="btn btn-primary" style="margin-top: 16px;">è¿”å›é¦–é¡µ</a>
                </div>
            `;
        }
    </script>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>Copyright Â© 2025 æ·˜ç¥¨ç¥¨ All Rights Reserved. | æ²ªICPå¤‡12345678å·</p>
            </div>
        </div>
    </footer>
</body>
</html>
